#!/bin/bash

# Unified Development Environment Launcher

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

case "$1" in
  "start"|"")
    # Start HTTP development in Docker
    exec "$SCRIPT_DIR/scripts/dev-docker.sh" "${@:2}"
    ;;
  "https")
    # Start HTTPS development in Docker
    exec "$SCRIPT_DIR/scripts/dev-docker.sh" --https "${@:2}"
    ;;
  "stop")
    echo "ðŸ›‘ Stopping all development services..."
    cd "$SCRIPT_DIR"
    docker compose down 2>/dev/null || true
    
    # Stop Supabase if running
    if command -v supabase &> /dev/null && supabase status >/dev/null 2>&1; then
      echo "ðŸ›‘ Stopping Supabase..."
      supabase stop >/dev/null 2>&1 || true
      echo "âœ… Supabase stopped"
    fi
    
    echo "âœ… All services stopped!"
    ;;
  "--no-logs")
    # Handle --no-logs as first argument
    exec "$SCRIPT_DIR/scripts/dev-docker.sh" --no-logs "${@:2}"
    ;;
  *)
    echo "Usage: $0 [start|https|stop] [options]"
    echo ""
    echo "Commands:"
    echo "  start (default)  Start full development environment (frontend + backend)"
    echo "  https           Start HTTPS development environment for mobile camera testing"
    echo "  stop            Stop all development services"
    echo ""
    echo "Examples:"
    echo "  $0              # Start full development environment"
    echo "  $0 start        # Start full development environment"
    echo "  $0 https        # Start HTTPS server for mobile camera testing"
    echo "  $0 stop         # Stop everything"
    echo ""
    echo "ðŸš€ Services included:"
    echo "   Frontend: Next.js app on http://localhost:3000"
    echo "   Backend:  FastAPI API on http://localhost:8000"
    echo "   Redis:    Job queue on localhost:6379"
    echo "   Database: PostgreSQL on localhost:5432 (with tables auto-created)"
    echo "   Celery:   Background workers for AI processing"
    echo "   Flower:   Celery monitoring on http://localhost:5555"
    echo "   Supabase: Auth & API on http://localhost:54321"
    echo "   Studio:   Supabase Studio on http://localhost:54323"
    echo ""
    echo "ðŸ“± For mobile camera testing:"
    echo "   Use '$0 https' to enable HTTPS with local certificates"
    echo "   On Windows WSL2, use '$0 https --wsl' to set up port forwarding + firewall so phones can reach the app"
    echo ""
    echo "ðŸ”§ Additional options:"
    echo "   --no-logs       Don't show container logs after startup"
    echo "   --wsl           (with https) Run PowerShell as Admin to set up portproxy + firewall for mobile access (Windows WSL2 only)"
    exit 1
    ;;
esac